// --- 1. INISIALISASI KONEKSI APPWRITE ---
const { Client, Databases, ID } = Appwrite;

const client = new Client()
    .setEndpoint('https://sgp.cloud.appwrite.io/v1') 
    .setProject('tenderwin'); // Sesuaikan dengan Project ID di Dashboard Appwrite kamu

const db = new Databases(client);

// --- 2. FUNGSI UTAMA GENERATE & SIMPAN ---
async function generate() {
    const name = document.getElementById('projName').value;
    const input = document.getElementById('rawInput').value;
    const btn = document.getElementById('btnGen');
    
    // API KEY GROQ (Llama 3.1)
    const apiKey = "gsk_XlWstnO4x63D0i9I2o53WGdyb3FYN1X4fG89jU0Kz7L7M3Q"; 

    if(!name || !input) return alert("Lengkapi judul dan detail proyek!");

    // UI Loading State
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('resultArea').classList.add('hidden');
    btn.disabled = true;

    try {
        // A. PROSES AI (LLAMA 3.1 70B)
        const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { 
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json" 
            },
            body: JSON.stringify({
                model: "llama-3.1-70b-versatile",
                messages: [
                    { 
                        role: "system", 
                        content: "Anda adalah TenderEngine v4. Ubah bahasa kasar menjadi proposal tender formal Indonesia yang sangat profesional. Fokus pada struktur teknis yang rapi." 
                    },
                    { 
                        role: "user", 
                        content: `Judul: ${name}\nDraft Kasar: ${input}` 
                    }
                ]
            })
        });

        const data = await res.json();
        const hasilAI = data.choices[0].message.content;

        // B. UPDATE TAMPILAN
        document.getElementById('output').innerText = hasilAI;
        document.getElementById('resultArea').classList.remove('hidden');

        // C. SIMPAN KE APPWRITE (SESUAI ATRIBUT DI GAMBAR KAMU)
        await db.createDocument(
            'main_db',      // ID Database (Pastikan sama di Appwrite)
            'proposals',    // ID Collection (Pastikan sama di Appwrite)
            ID.unique(), 
            {
                nama_proposal: name,        // Atribut sesuai gambar kamu
                final_proposal: hasilAI,    // Atribut (Size 50000)
                vendor_name: localStorage.getItem('tw_vendor') || "User-Internal" // Atribut vendor
            }
        );

        console.log("Data Berhasil di-Firebase ke Appwrite!");

    } catch (error) { 
        console.error("Error Detail:", error);
        alert("Gagal koneksi! Cek API Key atau Atribut Database."); 
    } finally { 
        document.getElementById('loader').classList.add('hidden');
        btn.disabled = false;
    }
}

// --- 3. FUNGSI COPY CLIPBOARD ---
function copy() {
    const text = document.getElementById('output').innerText;
    navigator.clipboard.writeText(text);
    alert("Proposal berhasil disalin!");
}
